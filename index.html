<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ramazan Hatim Rehberi - Canlƒ± & Disiplinli</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --gold: #d4af37;
            --turquoise: #14b8a6;
            --deep-bg: #0d1b1e;
            --overlay-bg: rgba(13, 27, 30, 0.95);
            --success: #10b981;
            --danger: #ef4444;
        }

        html, body { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--deep-bg); }
        body {
            font-family: 'Montserrat', sans-serif;
            background: radial-gradient(circle at top, #134e4a, var(--deep-bg));
            background-attachment: fixed;
            color: white; display: flex; justify-content: center; min-height: 100vh;
            padding: 20px; box-sizing: border-box; overflow-x: hidden;
        }

        #root { width: 100%; max-width: 500px; }
        .glass-card {
            background: var(--glass-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border); border-radius: 25px; padding: 25px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4); margin-bottom: 20px;
        }

        .logo-container { text-align: center; margin-bottom: 20px; }
        .logo-icon { width: 50px; height: 50px; fill: var(--gold); }
        .logo-text { font-weight: 600; letter-spacing: 3px; color: var(--gold); font-size: 1.2rem; margin: 10px 0 0 0; }
        
        .cuz-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 15px; }
        .cuz-item {
            aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 12px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.05);
            cursor: pointer; transition: 0.2s; position: relative;
        }
        .cuz-item.taken { border-color: var(--turquoise); background: rgba(20, 184, 166, 0.15); }
        .cuz-item.done { border-color: var(--gold); background: var(--success); }
        .cuz-item.delayed { border-color: var(--danger); background: rgba(239, 68, 68, 0.2); animation: pulse 2s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .cuz-num { font-size: 1.1rem; font-weight: 600; color: var(--gold); }
        .cuz-user { font-size: 0.6rem; opacity: 0.9; margin-top: 3px; text-align: center; color: white; width: 90%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .delay-warning { font-size: 0.5rem; color: var(--danger); font-weight: bold; margin-top: 2px; }

        .btn { width: 100%; padding: 14px; border-radius: 15px; font-weight: 600; border: none; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .btn-gold { background: var(--gold); color: #0d1b1e; }
        .btn-outline { background: transparent; border: 1px solid var(--gold); color: var(--gold); font-size: 0.8rem; }
        .btn-share { background: #25d366; color: white; }

        .input-glass {
            width: 100%; padding: 14px; border-radius: 15px; border: 1px solid var(--glass-border);
            background: rgba(255,255,255,0.1); color: white; outline: none; margin-bottom: 10px; box-sizing: border-box;
        }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--overlay-bg); display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(10px); }
        .modal { background: #0d1b1e; border: 2px solid var(--gold); width: 85%; max-width: 380px; border-radius: 25px; padding: 25px; text-align: center; max-height: 80vh; overflow-y: auto; }
        
        .progress-bar { height: 12px; background: rgba(255,255,255,0.1); border-radius: 6px; overflow: hidden; margin: 15px 0; border: 1px solid var(--glass-border); }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--turquoise), var(--gold)); transition: width 1s ease; }

        .archive-item { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 12px; margin-bottom: 8px; border-left: 4px solid var(--gold); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .history-list { text-align: left; font-size: 0.85rem; margin: 15px 0; }
        .history-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyCeCZ5qFTlbN8czSSigydmpAQf4KMLnyh8",
            authDomain: "kuranhatmi-e5963.firebaseapp.com",
            databaseURL: "https://kuranhatmi-e5963-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "kuranhatmi-e5963",
            storageBucket: "kuranhatmi-e5963.firebasestorage.app",
            messagingSenderId: "631276243606",
            appId: "1:631276243606:web:0f379e067527db6ad950b7"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function App() {
            const [user, setUser] = useState(localStorage.getItem('hatim_user_v1') || null);
            const [hatimData, setHatimData] = useState({});
            const [archive, setArchive] = useState({});
            const [selectedCuz, setSelectedCuz] = useState(null);
            const [viewArchive, setViewArchive] = useState(null);
            const [tempName, setTempName] = useState('');
            const [now, setNow] = useState(Date.now());

            useEffect(() => {
                db.ref('current_hatim').on('value', snap => setHatimData(snap.val() || {}));
                db.ref('archive').on('value', snap => setArchive(snap.val() || {}));
                
                const timer = setInterval(() => setNow(Date.now()), 60000); // Dakikada bir s√ºreyi kontrol et
                return () => { 
                    db.ref('current_hatim').off(); 
                    db.ref('archive').off(); 
                    clearInterval(timer);
                };
            }, []);

            const login = () => {
                if (tempName.trim()) {
                    setUser(tempName.trim());
                    localStorage.setItem('hatim_user_v1', tempName.trim());
                }
            };

            const takeCuz = (id) => {
                db.ref(`current_hatim/${id}`).set({ 
                    status: 'taken', 
                    owner: user,
                    startTime: Date.now() 
                });
                setSelectedCuz(null);
            };

            const completeCuz = (id) => {
                db.ref(`current_hatim/${id}`).update({ status: 'done' });
                setSelectedCuz(null);
            };

            const finalizeHatim = () => {
                if(confirm("Bu hatmi ar≈üive ta≈üƒ±yƒ±p yeni bir hatim ba≈ülatmak istediƒüinize emin misiniz?")) {
                    const newArchiveRef = db.ref('archive').push();
                    newArchiveRef.set({
                        date: new Date().toLocaleDateString('tr-TR'),
                        data: hatimData
                    });
                    db.ref('current_hatim').remove();
                }
            };

            const shareHatim = (type) => {
                let text = type === 'invite' 
                    ? `Ramazan Hatmimize sen de katƒ±l! Bir c√ºz se√ß, hayra ortak ol: ${window.location.href}`
                    : `M√ºjdeler olsun! Bir hatmi daha tamamladƒ±k. Allah kabul etsin! üìñ‚ú®`;
                
                if (navigator.share) {
                    navigator.share({ title: 'Hatim Rehberi', text: text });
                } else {
                    navigator.clipboard.writeText(text);
                    alert("Payla≈üƒ±m linki kopyalandƒ±!");
                }
            };

            const isDelayed = (startTime) => {
                if (!startTime) return false;
                const birHafta = 7 * 24 * 60 * 60 * 1000;
                return (Date.now() - startTime) > birHafta;
            };

            const doneCount = Object.values(hatimData).filter(c => c.status === 'done').length;
            const progress = (doneCount / 30 * 100).toFixed(1);

            if (!user) {
                return (
                    <div className="glass-card" style={{marginTop:'50px'}}>
                        <div className="logo-container"><h1 className="logo-text">Gƒ∞Rƒ∞≈û</h1></div>
                        <input className="input-glass" placeholder="Adƒ±nƒ±z Soyadƒ±nƒ±z" value={tempName} onChange={e => setTempName(e.target.value)} />
                        <button className="btn btn-gold" onClick={login}>KATIL</button>
                    </div>
                );
            }

            return (
                <div id="main-container">
                    <div className="glass-card">
                        <div className="logo-container">
                            <h1 className="logo-text">RAMAZAN HATMƒ∞</h1>
                            <p style={{color:'var(--turquoise)', fontSize:'0.75rem', marginTop:'5px'}}>Niyet Ettik Hatim Etmeye, {user}</p>
                        </div>

                        <div className="progress-bar"><div className="progress-fill" style={{width: `${progress}%`}}></div></div>
                        <div style={{display:'flex', justifyContent:'space-between', fontSize:'0.8rem', color:'var(--gold)', fontWeight:'600'}}>
                            <span>Hatim: %{progress}</span>
                            <span>{doneCount}/30 C√ºz</span>
                        </div>

                        <div className="cuz-list">
                            {Array.from({ length: 30 }, (_, i) => {
                                const id = i + 1;
                                const info = hatimData[id] || { status: 'free', owner: '' };
                                const delayed = info.status === 'taken' && isDelayed(info.startTime);
                                return (
                                    <div key={id} className={`cuz-item ${info.status} ${delayed ? 'delayed' : ''}`} onClick={() => setSelectedCuz({id, ...info, delayed})}>
                                        <span className="cuz-num">{id}</span>
                                        <span className="cuz-user">{info.owner || 'Bo≈üta'}</span>
                                        {delayed && <span className="delay-warning">GECƒ∞KTƒ∞!</span>}
                                    </div>
                                );
                            })}
                        </div>

                        <button className="btn btn-outline" style={{marginTop:'20px'}} onClick={() => shareHatim('invite')}>
                            KATILIM ƒ∞√áƒ∞N GRUPTA PAYLA≈û üöÄ
                        </button>

                        {progress >= 100 && (
                            <button className="btn btn-gold" style={{background: 'var(--success)', color:'white', marginTop:'15px'}} onClick={finalizeHatim}>
                                HATMƒ∞ TAMAMLA VE YENƒ∞Sƒ∞Nƒ∞ BA≈ûLAT üéâ
                            </button>
                        )}
                    </div>

                    {Object.keys(archive).length > 0 && (
                        <div className="glass-card">
                            <h3 style={{color:'var(--gold)', fontSize:'1rem', marginBottom:'15px'}}>Biten Hatimler</h3>
                            {Object.entries(archive).reverse().map(([key, item]) => (
                                <div key={key} className="archive-item" onClick={() => setViewArchive(item)}>
                                    <div>
                                        <div style={{fontSize:'0.9rem', fontWeight:'600'}}>Tamamlanan Hatim</div>
                                        <div style={{fontSize:'0.7rem', opacity:0.7}}>{item.date}</div>
                                    </div>
                                    <span>üìñ</span>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* MODAL: C√ºz ƒ∞≈ülemleri */}
                    {selectedCuz && (
                        <div className="overlay" onClick={() => setSelectedCuz(null)}>
                            <div className="modal" onClick={e => e.stopPropagation()}>
                                <h2 style={{color:'var(--gold)'}}>{selectedCuz.id}. C√úZ</h2>
                                {selectedCuz.status === 'free' ? (
                                    <>
                                        <p>Bu c√ºz√º okumayƒ± √ºstlenmek √ºzeresiniz. L√ºtfen bitireceƒüinizden emin olun.</p>
                                        <button className="btn btn-gold" onClick={() => takeCuz(selectedCuz.id)}>S√ñZ, √úSTLENƒ∞YORUM</button>
                                    </>
                                ) : selectedCuz.owner === user ? (
                                    selectedCuz.status === 'taken' ? (
                                        <>
                                            {selectedCuz.delayed && <p style={{color:'var(--danger)', fontWeight:'600'}}>‚ö†Ô∏è 1 haftayƒ± ge√ßtiniz, l√ºtfen hƒ±zlanalƒ±m!</p>}
                                            <p>Bu c√ºz√º bitirdiysen a≈üaƒüƒ±daki butona bas.</p>
                                            <button className="btn btn-gold" onClick={() => completeCuz(selectedCuz.id)}>TAMAMLADIM ‚úÖ</button>
                                            <p style={{fontSize:'0.7rem', marginTop:'15px', opacity:0.6}}>Okumaya niyet ettiƒüiniz c√ºz√º bƒ±rakamazsƒ±nƒ±z. Tamamlamak bir s√∂zd√ºr.</p>
                                        </>
                                    ) : <p style={{color:'var(--success)', fontWeight:'600'}}>Ma≈üallah, bu c√ºz√º tamamladƒ±nƒ±z!</p>
                                ) : (
                                    <div style={{textAlign:'center'}}>
                                        <p>Bu c√ºz ≈üu an <b>{selectedCuz.owner}</b> tarafƒ±ndan okunuyor.</p>
                                        {selectedCuz.delayed && <p style={{color:'var(--danger)', fontWeight:'600'}}>Hƒ±zlandƒ±rƒ±lmasƒ± i√ßin arkada≈üƒ±nƒ±za hatƒ±rlatƒ±n.</p>}
                                    </div>
                                )}
                                <button className="btn btn-outline" style={{marginTop:'20px'}} onClick={() => setSelectedCuz(null)}>Kapat</button>
                            </div>
                        </div>
                    )}

                    {/* MODAL: Ar≈üiv Detayƒ± */}
                    {viewArchive && (
                        <div className="overlay" onClick={() => setViewArchive(null)}>
                            <div className="modal" onClick={e => e.stopPropagation()}>
                                <h2 style={{color:'var(--gold)', margin:'0'}}>HATƒ∞M √ñZETƒ∞</h2>
                                <p style={{fontSize:'0.8rem', opacity:0.7}}>{viewArchive.date} tarihinde tamamlandƒ±</p>
                                <div className="history-list">
                                    {Array.from({length:30}, (_,i)=>i+1).map(id => (
                                        <div key={id} className="history-row">
                                            <span>{id}. C√ºz</span>
                                            <span style={{color:'var(--turquoise)'}}>{viewArchive.data[id]?.owner || '-'}</span>
                                        </div>
                                    ))}
                                </div>
                                <button className="btn btn-share" onClick={() => shareHatim('complete')}>BU M√úJDEYƒ∞ PAYLA≈û üì±</button>
                                <button className="btn btn-outline" onClick={() => setViewArchive(null)}>KAPAT</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
